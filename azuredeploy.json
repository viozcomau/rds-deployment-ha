{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "projectName": {
      "type": "string",
      "metadata": {
        "description": "Project name will be suffixed and tagged to resources"
      },
      "defaultValue": ""
    },
    "gwdnsLabelPrefix": {
      "type": "string",
      "metadata": {
        "description": "Unique public DNS prefix for the deployment. The fqdn will look something like '<dnsname>.westus.cloudapp.azure.com'. Up to 62 chars, digits or dashes, lowercase, should start with a letter: must conform to '^[a-z][a-z0-9-]{1,61}[a-z0-9]$'. For example johndns1 will result the final RDWEB access url like https://johndns1.westus.cloudapp.azure.com/RDWeb"
      },
      "defaultValue": "cloudapps"
    },
    "adDomainName": {
      "type": "string",
      "metadata": {
        "description": "The name of the existing AD domain. For example contoso.com"
      },
      "defaultValue": "contoso.com"
    },
    "adminUserName": {
      "type": "string",
      "metadata": {
        "description": "The existing name of the administrator account in the domain. Exclusion list: 'administrator'. For example johnadmin"
      },
      "defaultValue": "cloudadmin"
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password for the administrator account in the domain"
      },
      "defaultValue": "[concat('Subscription#',subscription().subscriptionId)]"
    },
    "imageSKU": {
      "type": "string",
      "allowedValues": [
        "2012-R2-Datacenter",
        "2016-Datacenter"
      ],
      "metadata": {
        "description": "Windows server SKU"
      },
      "defaultValue": "2016-Datacenter"
    },
    "numberOfRdshInstances": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "Number of total Remote Desktop Session Hosts to create."
      }
    },
    "vmRdshSize": {
      "type": "string",
      "metadata": {
        "description": "The size of the RDSH VMs"
      },
      "defaultValue": "Standard_A2_v2"
    },
    "numberOfWebGwInstances": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Number of additional RD Gateway / RD Web Access servers. value of 1 will give a total of 2 for HA."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources."
      }
    }
  },
  "variables": {
    "_artifactsLocation": "https://raw.githubusercontent.com/viozcomau/rds-deployment-ha/master/",
    "basicRDSDeploymentLocation": "[concat(variables('_artifactsLocation'),'rds-deployment-basic')]",
    "basicRDSDeploymentTemplate": "azuredeploy.json",
    "basicRDSDeploymentName": "CreateBasicRDSDeployment",
    "basicRDSDeploymentURL": "[concat(variables('basicRDSDeploymentLocation'),'/',variables('basicRDSDeploymentTemplate'))]",
    "rdGatewayWebHAexistingRDSLocation": "[concat(variables('_artifactsLocation'),'rds-deployment-ha-gateway')]",
    "rdGatewayWebHAexistingRDSTemplate": "azuredeploy.json",
    "rdGatewayWebHAexistingRDS": "CreateRDGatewayWebAccessHA",
    "rdGatewayWebHAURL": "[concat(variables('rdGatewayWebHAexistingRDSLocation'),'/',variables('rdGatewayWebHAexistingRDSTemplate'))]",
    "sslDeploymentexistingRDSLocation": "[concat(variables('_artifactsLocation'),'rds-update-certificate')]",
    "sslDeploymentexistingRDSTemplate": "azuredeploy.json",
    "sslDeploymentexistingRDS": "configureSSLonRDSDeployment",
    "sslDeploymentURL": "[concat(variables('sslDeploymentexistingRDSLocation'),'/',variables('sslDeploymentexistingRDSTemplate'))]",
    "RdcbHaDeploymentexistingRDSLocation": "[concat(variables('_artifactsLocation'),'rds-deployment-ha-broker')]",
    "RdcbHaDeploymentexistingRDSTemplate": "azuredeploy.json",
    "RdcbHaDeploymentexistingRDS": "configureRdcbHaonRDSDeployment",
    "RdcbHaDeploymentURL": "[concat(variables('RdcbHaDeploymentexistingRDSLocation'),'/',variables('RdcbHaDeploymentexistingRDSTemplate'))]",

    "vmPrefix": "vm-",
    "vnetPrefix": "vnet-",
    "snetPrefix": "snet-",
    "nsgPrefix": "nsg-",
    "lbPrefix": "lb-",
    "pipPrefix": "pip-",

    "availabilitySetPrefix": "avail-",
    "adName": "ad-1",
    "gwName": "gw-1",
    "cbName": "cb-1",
    "vnetName": "[concat(variables('vnetPrefix'),parameters('projectName'))]",
    "subnetName": "[concat(variables('subnetName'),parameters('projectName'))]",
    "loadBalancer": "[concat(variables('lbPrefix'),'gw')]",
    "gatewaypublicIp": "[concat(variables('pipPrefix'),'gw')]",
    "backEndAddressPool": "LBBAP",
    "availGwName": "[concat(variables('availabilitySetPrefix'),'gw')]",
    "availCbName": "[concat(variables('availabilitySetPrefix'),'cb')]",

    "stDiagName": "[tolower(concat('rdsa', uniqueString(resourceGroup().id)))]",
    "vmGwName": "[concat(variables('vmPrefix'), variables('gwName'))]",
    "gwExternalFqdn": "[concat(variables('vmGwName'), '.', parameters('adDomainName'))]",

    "vmCbName": "[concat(variables('vmPrefix'),variables('cbName'))]",
    "cbServerName": "[concat(variables('vmCbName'), '.', parameters('adDomainName'))]",

    "brokerHostName": "[variables('vmCbName')]"
  },
  "resources": [
    {
      "name": "[variables('basicRDSDeploymentName')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-02-01",
      "dependsOn": [
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('basicRDSDeploymentURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "_artifactsLocation": {
            "value": "[variables('basicRDSDeploymentLocation')]"
          },
          "gwdnsLabelPrefix": {
            "value": "[parameters('gwdnsLabelPrefix')]"
          },
          "adDomainName": {
            "value": "[parameters('adDomainName')]"
          },
          "vnetName": {
            "value": "[variables('vnetName')]"
          },
          "subnetName": {
            "value": "[variables('subnetName')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUserName')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "imageSKU": {
            "value": "[parameters('imageSKU')]"
          },
          "numberOfRdshInstances": {
            "value": "[parameters('numberOfRdshInstances')]"
          },
          "vmRdshSize": {
            "value": "[parameters('vmRdshSize')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "lbNameGw": {
            "value": "[variables('loadBalancer')]"
          },
          "availGwName": {
            "value": "[variables('availGwName')]"
          },
          "availCbName": {
            "value": "[variables('availCbName')]"
          },
          "vmGwName": {
            "value": "[variables('vmGwName')]"
          },
          "vmCbName": {
            "value": "[variables('vmCbName')]"
          }
        }
      }
    }
  ],
  "outputs": {
  }
}